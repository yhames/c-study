# 전문가를 위한 C - Chapter 3 목적파일 : 동적 라이브러리

- [전문가를 위한 C - Chapter 3 목적파일 : 동적 라이브러리](#전문가를-위한-c---chapter-3-목적파일--동적-라이브러리)
  - [동적 라이브러리](#동적-라이브러리)
    - [공유 라이브러리 수동 로딩](#공유-라이브러리-수동-로딩)

## 동적 라이브러리

실행파일에 포함되는 정적 라이브러리와는 다르게
`동적 라이브러리`는 실행을 위한 프로세스가 로딩될 때 가져와서 로드된다.

정적 라이브러리는 실행 파일의 일부이다.
즉, 링커는 정의되지 않은 심벌을 감지하여 정적 라이브러리에서 주어진 재배치 가능한 목적 파일을 찾고 최종파일에 모든 것을 집어 넣는다.

반면, `동적 라이브러리`는 정의되지 않은 `심벌`을 가질 수 있다.
정의되지 않은 `심벌`은 `링크` 단계에서 해결되지 않고 `실행 파일`이 로드되고 실행을 시작할 떄 `동적 링커` 혹은 `로더`(`loarder`)가 `심벌`을 탐색한다.

동적 라이브러리는 리눅스에서 `.so`, macOS에서 `.dylib` 확장자를 갖는다.

프로세스가 로드하고 실행할 때 공유 목적 파일이 로드되고
프로세스가 접근할 수 있는 메모리 지역에 이 파일이 연결된다.

동적 라이브러리의 심벌은 상대 주소를 갖는다.
따라서 심벌이 여러 프로세스에 동시에 연결이 되어도 프로세스의 오프셋에 상대적으로 고정된다.
예를 들어, 두 명령어가 100과 200의 상대주소에 위차한다고 가정했을 때 한 프로세스에서는 140, 240, 다른 프로세스에서는 323, 423에 위치하는 것이다. 두 명령어는 언제나 100만큼 떨어져 있다.

공유 목적 파일을 만들기 위해서는 재배치 가능한 목적 파일을 만들 때
 gcc의 -fPIC 옵션을 사용해야한다.
PIC는 Position Independent Code를 나타낸다.

```shell
gcc -c ExtremeC_examples_chapter3_2_2d.c -fPIC -o 2d.o
gcc -c ExtremeC_examples_chapter3_2_3d.c -fPIC -o 3d.o
gcc -c ExtremeC_examples_chapter3_2_trigon.c -fPIC -o trigon.o
```

다음은 상대 주소를 갖는(위치 독립적인) 재배치 가능한 목적파일로부터 공유 목적 파일을 생성하는 명령이다.

```bash
gcc -shared 2d.o 3d.o trigon.o -o libgeometry.dylib
```

다음은 동적 라이브러리르 사용하는 실행파일을 만드는 명령어이다.

```bash
gcc main.o -L./ -lgeometry -lm -o ex3_3.out
```

`ex3_3.out`을 실행하면 정삭적으로 동작하는 것을 볼 수 있다.

추가로 `-L` 옵션을 사용하면 `지정하는 위치`에서 `-l`에 해당하는 정적 혹은 동적 라이브러리를 가져온다.

`정적 라이브러리` 같은 경우에는 해당 파일로부터 모든 것을 복제하기 때문에 더 이상 라이브러리 파일에 의존적이지 않다.

`동적 라이브러리` 같은 경우에는 옵션을 사용해도 독립 실행파일에서는 여전히 라이브러리 파일에 의존적이기 때문에 `기본 탐색 경로`를 따로 설정해줘야한다.  
리눅스에서는 `LD_LIBRARY_PATH`, macOS에서는 `DYLD_LIBRARY_PATH`를 사용한다.

따라서 책의 예제와 같이 `/opt/geometry`에 옮겨서 로드하는 경우
다음 명령어를 실행하거나 `.zshrc`에 명령어를 입력해야한다.

```bash
export DYLD_LIBRARY_PATH="/opt/geometry"
```

### 공유 라이브러리 수동 로딩

동적 라이브러리를 코드 내에서 수동으로 로드하기 위해서는
추가적인 작업이 필요하다

다음 동적 라이브러리 수동 로딩을 위해 libgeometry.dylib 생성시 내부적인 의존성을 추가하는 명령이다.

```zsh
gcc -shared 2d.o 3d.o trigon.o -lm -o libgeometry.dylib
```

`libgeometry.dylib`가 의존하는 라이브러리가 자동으로 로드되어야하기 때문에 `-lm`을 추가했다. `-lm`은 `libm.a` 혹은 `libm.dylib`을 의미하며, `cos`, `sin`, `acos` 등의 함수를 사용하기 위한 `glibc`의 수학 함수에 관한 정의가 들어있다.

`ExtremeC_examples_chatper3_4.c`를 보면 동적 라이브러리를 수동으로 로드하기 위해 `dlopen()`과 `dlsym()` 함수를 사용한다.
`dlopen()`은 지정 위치에 있는 `동적 라이브러리`를 가져오고,
`dlsym()`은 `dlopen`로 불러온 `동적 라이브러리`에서 매개변수로 지정한 `함수`를 `함수포인터`로 반환한다.

다음은 수동으로 동적 라이브러리를 로드하는 gcc 명령어이다.

```bash
gcc ExtremeC_examples_chatper3_4.c -ldl -o ex3_4.out
```

ex3_4.out을 실행하면 정상적으로 동작하는 것을 볼 수 있다.

이러한 방법을 `지연로딩`(`Lazy Loading`)이라고 한다.
